<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PRISMA — Dashboard</title>
  <link rel="icon" href="assets/prisma-logo.png"/>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar__inner container">
      <button class="menu-btn" aria-label="Menú" id="btnMenu">☰</button>
      <a class="brand" href="index.html" aria-label="Inicio">
        <img src="assets/prisma-logo.png" alt="Logo PRISMA" class="logo"/>
        <span class="brand__text">
          <span class="brand__name">PRISMA</span><br/>
          <span class="brand__tag">Seguridad Industrial · ISO 45001</span>
        </span>
      </a>
      <nav class="nav" id="mainNav" aria-label="Principal">
        <a href="index.html">Inicio</a>
        <a href="dashboard.html" class="badge badge--brand">Dashboard</a>
        <a href="trabajador.html">Trabajador</a>
        <a href="entrenamiento.html">Entrenamiento</a>
        <a href="sensores.html">Sensores</a>
        <a href="reportes.html">Reportes</a>
        <a href="auth.html">Salir</a>
      </nav>
    </div>
  </header>

  <main class="container" style="padding-top:18px">
    <!-- KPIs -->
    <section class="card">
      <h2 class="section-title">Resumen de hoy</h2>
      <div class="kpis">
        <div class="kpi"><span class="muted">Incidentes</span><b id="kpiInc">—</b></div>
        <div class="kpi"><span class="muted">Cumplimiento</span><b id="kpiComp">—%</b></div>
        <div class="kpi"><span class="muted">Capacitaciones</span><b id="kpiCap">—</b></div>
      </div>
    </section>

    <!-- Grid -->
    <section class="grid-3" style="margin-top:16px">
      <!-- Incidentes -->
      <article class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Incidentes por área</h3>
          <span class="badge badge--warn">Mes actual</span>
        </div>
        <div class="hero__panel" style="height:220px;display:flex;align-items:center;justify-content:center">
          <small class="muted">[Gráfico] conecta tu librería (Chart.js, ECharts)</small>
        </div>
        <div class="list" style="margin-top:8px">
          <div class="item"><b>Producción</b><div class="muted" id="incProd">—</div></div>
          <div class="item"><b>Laboratorio</b><div class="muted" id="incLab">—</div></div>
        </div>
        <div class="cta" style="margin-top:10px">
          <button class="btn btn--secondary" id="btnExpInc">Exportar CSV</button>
        </div>
      </article>

      <!-- ISO -->
      <article class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>ISO 45001 · Checklist</h3>
          <span class="badge badge--ok" id="chkState">En curso</span>
        </div>
        <ul class="list" style="margin-top:10px">
          <li class="item"><label><input type="checkbox" class="chk" data-w="25"> Liderazgo y compromiso</label></li>
          <li class="item"><label><input type="checkbox" class="chk" data-w="25"> Identificación de peligros</label></li>
          <li class="item"><label><input type="checkbox" class="chk" data-w="25"> Competencia y capacitación</label></li>
          <li class="item"><label><input type="checkbox" class="chk" data-w="25"> Respuesta ante emergencias</label></li>
        </ul>
        <div class="cta" style="margin-top:12px">
          <button class="btn btn--primary" id="btnCalc">Calcular %</button>
          <a class="btn btn--secondary" href="reportes.html">Generar reporte</a>
        </div>
      </article>

      <!-- Acciones rápidas -->
      <article class="card sos">
        <h3>Alertas rápidas</h3>
        <p class="muted">Dispara protocolos y notifica a supervisores.</p>
        <div class="cta">
          <button class="btn btn--primary" data-alerta="Incendio">🚨 Incendio</button>
          <button class="btn btn--secondary" data-alerta="Evacuación">🏃 Evacuación</button>
          <button class="btn" style="background:#fff;border:1px solid #e2e8f0" data-alerta="Pánico">🆘 Botón de pánico</button>
        </div>
      </article>

      <!-- Capacitaciones -->
      <article class="card">
        <h3>Capacitación activa</h3>
        <ul class="list" id="capList">
          <!-- llena con tus datos -->
        </ul>
        <div class="cta" style="margin-top:10px">
          <a class="btn btn--secondary" href="entrenamiento.html">Continuar</a>
        </div>
      </article>

      <!-- Sensores -->
      <article class="card">
        <h3>Sensores en tiempo real</h3>
        <table class="table" style="margin-top:10px" id="tblSens">
          <thead><tr><th>Dispositivo</th><th>Valor</th><th>Estado</th></tr></thead>
          <tbody><!-- llena con tus lecturas --></tbody>
        </table>
        <div class="cta" style="margin-top:10px">
          <a class="btn" style="background:#fff;border:1px solid #e2e8f0" href="sensores.html">Ver todo</a>
        </div>
      </article>

      <!-- Mapa -->
      <article class="card">
        <h3>Mapa de riesgos</h3>
        <div class="hero__panel" style="height:220px;display:flex;align-items:center;justify-content:center">
          <small class="muted">[Mapa] integra Leaflet / Mapbox</small>
        </div>
        <div class="cta" style="margin-top:10px">
          <a class="btn btn--primary" href="reportes.html#mapa">Exportar mapa</a>
        </div>
      </article>
    </section>

    <!-- Reportes recientes -->
    <section class="card" style="margin-top:16px">
      <h3>Últimos reportes</h3>
      <table class="table" style="margin-top:10px" id="tblRep">
        <thead><tr><th>Fecha</th><th>Área</th><th>Tipo</th><th>Estado</th><th>Acciones</th></tr></thead>
        <tbody><!-- llena desde tu backend --></tbody>
      </table>
    </section>
  </main>

  <footer class="footer">
    <div class="container">© <span id="yy"></span> PRISMA — Seguridad e Higiene · ISO 45001</div>
  </footer>

  <script>
    // Menú móvil
    document.getElementById('btnMenu')?.addEventListener('click', ()=>{
      document.getElementById('mainNav').classList.toggle('open');
    });
    document.getElementById('yy').textContent = new Date().getFullYear();

    /* ====== PUNTOS DE INTEGRACIÓN (reemplaza por tus fetch a Supabase/API) ======
       Ejemplos de contratos de datos esperados:
       - KPIs: {incidentes:Number, cumplimiento:Number, capsCompletas:Number}
       - Incidentes por área: [{area:"Producción", total: N}, {area:"Laboratorio", total: N}]
       - Capacitaciones: [{title:"Uso de EPP", estado:"Completado"|"Pendiente"}]
       - Sensores: [{name:"CO₂ · Almacén", val:"420 ppm", ok:true}]
       - Reportes: [{ts:"2025-01-01", area:"Producción", type:"Incidente", state:"Revisión"}]
    ============================================================================ */

    // Ejemplo de “setters” de UI (no traen datos, solo actualizan el DOM):
    function setKPIs({incidentes, cumplimiento, capsCompletas}){
      document.getElementById('kpiInc').textContent  = (incidentes ?? '—');
      document.getElementById('kpiComp').textContent = (cumplimiento ?? '—') + (cumplimiento!=null?'%':'');
      document.getElementById('kpiCap').textContent  = (capsCompletas ?? '—');
    }

    function setIncidentesPorArea(arr){
      const prod = (arr||[]).find(a=>a.area==='Producción')?.total ?? '—';
      const lab  = (arr||[]).find(a=>a.area==='Laboratorio')?.total ?? '—';
      document.getElementById('incProd').textContent = prod;
      document.getElementById('incLab').textContent  = lab;
    }

    function setCapacitaciones(list){
      const box = document.getElementById('capList'); box.innerHTML='';
      (list||[]).forEach(c=>{
        const li=document.createElement('li'); li.className='item';
        li.innerHTML = `<b>${c.title}</b> <div class="muted">${c.estado||''}</div>`;
        box.appendChild(li);
      });
    }

    function setSensores(rows){
      const tb=document.querySelector('#tblSens tbody'); tb.innerHTML='';
      (rows||[]).forEach(s=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${s.name}</td><td>${s.val||'—'}</td>
                        <td><span class="badge ${s.ok?'badge--ok':'badge--warn'}">${s.ok?'Normal':'Atento'}</span></td>`;
        tb.appendChild(tr);
      });
    }

    function setReportes(rows){
      const tb=document.querySelector('#tblRep tbody'); tb.innerHTML='';
      (rows||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.ts||'—'}</td><td>${r.area||'—'}</td><td>${r.type||'—'}</td>
                        <td><span class="badge ${r.state==='Revisión'?'badge--warn':'badge--ok'}">${r.state||'—'}</span></td>
                        <td><a class="btn" style="background:#fff;border:1px solid #e2e8f0" href="reportes.html">Abrir</a></td>`;
        tb.appendChild(tr);
      });
    }

    // Exportar CSV (llamalo luego de tener datos)
    document.getElementById('btnExpInc').addEventListener('click', ()=>{
      // reemplazá 'data' por tu arreglo real de incidentes
      const data = window.__INCIDENTES__ || [];
      const rows=[["fecha","area","tipo","estado"], ...data.map(i=>[i.ts,i.area,i.type,i.state])];
      const csv = rows.map(r=>r.map(x=>`"${String(x??'').replaceAll('"','""')}"`).join(',')).join('\n');
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      a.download='prisma_incidentes.csv'; a.click(); URL.revokeObjectURL(a.href);
    });

    // Botones de alerta (conecta con tu backend de notificaciones)
    document.querySelectorAll('[data-alerta]').forEach(b=>{
      b.addEventListener('click', ()=> {
        const tipo=b.getAttribute('data-alerta');
        // TODO: fetch('/api/alertas', {method:'POST', body: JSON.stringify({tipo})})
        alert('Alerta enviada: '+tipo);
      });
    });

    /* ====== EJEMPLO DE USO (cuando tengas datos reales, quitá este bloque) ======
    setKPIs({incidentes: 0, cumplimiento: 92, capsCompletas: 7});
    setIncidentesPorArea([{area:'Producción', total:2},{area:'Laboratorio', total:1}]);
    setCapacitaciones([{title:'Uso de EPP', estado:'Completado'},{title:'Prevención de incendios', estado:'Pendiente'}]);
    setSensores([{name:'CO₂ · Almacén', val:'420 ppm', ok:true},{name:'Temp. · Producción', val:'31 °C', ok:false}]);
    setReportes([{ts:'2025-09-09', area:'Producción', type:'Incidente leve', state:'Revisión'}]);
    window.__INCIDENTES__ = [{ts:'2025-09-09', area:'Producción', type:'Incidente leve', state:'Revisión'}];
    ============================================================================ */
  </script>
</body>
</html>
```0
