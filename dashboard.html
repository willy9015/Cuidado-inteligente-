<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard ‚Äî Guardi√°n 360</title>
  <link rel="icon" href="assets/logo-guardian360.png"/>
  <link rel="stylesheet" href="css/style.css"/>

  <!-- (Opcional) Firebase Auth solo para verificar sesi√≥n y permitir cerrar sesi√≥n -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    // üëâ Reemplaza con tu config de Firebase (o elimina este bloque si no usar√°s Firebase en el dashboard)
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROYECTO.firebaseapp.com",
      projectId: "TU_PROYECTO",
      appId: "1:XXXX:web:XXXX"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    window.doLogout = () => signOut(auth).then(()=>location.href="auth.html");

    onAuthStateChanged(auth, (user) => {
      const badge = document.getElementById("userBadge");
      if (user) {
        badge.textContent = user.email || "Usuario";
        // contin√∫a normal
      } else {
        // Si quer√©s obligar login: descoment√°
        // location.href = "auth.html";
      }
    });
  </script>

  <script>
    /* ================== Estado local (funciona sin backend) ================== */
    const S = {
      incidents: JSON.parse(localStorage.getItem('g360_inc')||'[]'),
      workers:   JSON.parse(localStorage.getItem('g360_workers')||'[]'),
      sensors:   JSON.parse(localStorage.getItem('g360_sensors')||'[]'),
      readings:  JSON.parse(localStorage.getItem('g360_readings')||'[]'),
      caps:      JSON.parse(localStorage.getItem('g360_caps')||'[]'),
      compliance: +localStorage.getItem('g360_comp')||0
    };
    if (S.sensors.length===0) {
      S.sensors = [
        {id:'s1',name:'CO‚ÇÇ',unit:'ppm',min:350,max:1500},
        {id:'s2',name:'Temperatura',unit:'¬∞C',min:10,max:45},
        {id:'s3',name:'Ruido',unit:'dB',min:0,max:85}
      ];
    }
    if (S.caps.length===0) {
      S.caps = [
        {id:'epp', title:'Uso correcto de EPP', done:false},
        {id:'inc', title:'Prevenci√≥n de incendios', done:false},
        {id:'quim', title:'Manejo de qu√≠micos', done:false}
      ];
    }
    saveAll();

    function saveAll(){
      localStorage.setItem('g360_inc', JSON.stringify(S.incidents));
      localStorage.setItem('g360_workers', JSON.stringify(S.workers));
      localStorage.setItem('g360_sensors', JSON.stringify(S.sensors));
      localStorage.setItem('g360_readings', JSON.stringify(S.readings));
      localStorage.setItem('g360_caps', JSON.stringify(S.caps));
      localStorage.setItem('g360_comp', S.compliance);
    }

    const $ = (q,el=document)=>el.querySelector(q);
    function isToday(ts){ const d=new Date(ts), t=new Date(); return d.toDateString()===t.toDateString(); }

    /* ================== Bot√≥n de p√°nico ================== */
    async function triggerEmergency(){
      let loc = "sin GPS";
      try{
        const pos = await new Promise((res,rej)=>navigator.geolocation?
          navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:7000}):rej("no geo"));
        loc = pos.coords.latitude.toFixed(5)+", "+pos.coords.longitude.toFixed(5);
      }catch(e){}
      navigator.vibrate?.([140,40,140]);
      S.incidents.push({ ts: Date.now(), type:"Emergencia", loc, sev: ["Bajo","Medio","Alto"][Math.floor(Math.random()*3)] });
      saveAll(); renderKPIs(); renderTables();
      alert("üö® Emergencia registrada");
    }

    /* ================== Sensores: generar lecturas demo ================== */
    let sensTimer;
    function startSensorsLoop(){
      clearInterval(sensTimer);
      sensTimer = setInterval(()=>{
        S.sensors.forEach(s=>{
          const base=(s.min+s.max)/2, amp=(s.max-s.min)/2||25;
          const val= base + (Math.random()*amp*2 - amp);
          S.readings.push({ts:Date.now(), id:s.id, val});
          if(S.readings.length>600) S.readings.shift();
        });
        saveAll(); drawMini('chartSens', lastN(S.readings.map(r=>r.val), 40), "#34d399");
      }, 2000);
    }

    /* ================== Render ================== */
    function renderKPIs(){
      $('#kpiIncidentes').textContent = S.incidents.filter(i=>isToday(i.ts)).length;
      $('#kpiSensores').textContent   = S.sensors.length;
      const done = S.caps.filter(c=>c.done).length;
      $('#kpiCaps').textContent       = `${done}/${S.caps.length}`;
      $('#kpiComp').textContent       = (S.compliance||0).toFixed(0)+"%";

      drawMini('chartInc', lastN(S.incidents.map((_,i)=>i+1), 20), "#60a5fa");
      drawMini('chartComp', sparkPercent(), "#f59e0b");

      const small = $('#sensSmall'); small.innerHTML='';
      S.sensors.slice(0,4).forEach(s=>{
        const r = latestReading(s.id);
        const ok = r ? (r.val>=s.min && r.val<=s.max) : true;
        const li = document.createElement('div');
        li.innerHTML = `<span class="badge">${s.name}</span> ${r? r.val.toFixed(1)+' '+s.unit:'‚Äî'} <span class="badge" style="border-color:${ok?'#22c55e':'#ef4444'}">${ok?'OK':'‚ö†'}</span>`;
        small.appendChild(li);
      });
    }

    function renderTables(){
      // Incidentes
      const tb = $('#tInc tbody'); tb.innerHTML='';
      S.incidents.slice().reverse().forEach(i=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${new Date(i.ts).toLocaleString()}</td><td>${i.type}</td><td>${i.loc}</td><td class="right">${i.sev}</td>`;
        tb.appendChild(tr);
      });

      // Capacitaciones
      const cap = $('#tCap tbody'); cap.innerHTML='';
      S.caps.forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${c.title}</td><td class="right">${c.done?'‚úÖ':'‚è≥'}</td>`;
        cap.appendChild(tr);
      });
    }

    function latestReading(id){ const arr=S.readings.filter(r=>r.id===id); return arr[arr.length-1]; }
    function lastN(a,n){ return a.slice(-n); }
    function sparkPercent(){
      const base = Math.max(40, Math.min(100, S.compliance||55));
      const arr = Array.from({length:20},(_,i)=> Math.max(35, Math.min(100, base + (Math.random()*10-5))));
      return arr;
    }

    /* ================== Mini charts en canvas ================== */
    function drawMini(id, data, color="#60a5fa"){
      const c = document.getElementById(id); if(!c) return;
      const ctx = c.getContext('2d');
      const w = c.width = c.clientWidth || 260;
      const h = c.height = c.clientHeight || 120;
      ctx.clearRect(0,0,w,h);
      if(!data || !data.length) return;
      const pad=10, min=Math.min(...data), max=Math.max(...data);
      ctx.strokeStyle="#334155"; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
      ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
      data.forEach((v,i)=>{
        const x = pad + i*((w-2*pad)/Math.max(1,data.length-1));
        const y = h-pad - ((v-min)/(max-min||1))*(h-2*pad);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    /* ================== Export CSV ================== */
    function exportCSV(kind){
      let rows=[["ts"]];
      if(kind==="incidentes"){
        rows=[["fecha","tipo","ubicacion","severidad"]];
        S.incidents.forEach(i=>rows.push([new Date(i.ts).toISOString(), i.type, i.loc, i.sev]));
      }
      const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
      a.download=`g360_${kind}.csv`; a.click(); URL.revokeObjectURL(a.href);
    }

    /* ================== Init ================== */
    window.addEventListener('DOMContentLoaded', ()=>{
      renderKPIs();
      renderTables();
      startSensorsLoop();

      // Navegaci√≥n a m√≥dulos (archivos separados que construir√°s)
      document.querySelectorAll('[data-go]').forEach(b=>{
        b.addEventListener('click', ()=> location.href = b.dataset.go + ".html");
      });

      // Bot√≥n de p√°nico
      document.getElementById('panicBtn').addEventListener('click', triggerEmergency);

      // Export
      document.getElementById('expInc').addEventListener('click', ()=>exportCSV('incidentes'));
    });
  </script>

  <style>
    /* Estilos m√≠nimos para que sea aut√≥nomo si tu CSS no est√° a√∫n */
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#111827; --muted:#1f2937;
      --text:#f8fafc; --sub:#94a3b8;
      --blue:#2563eb; --green:#22c55e; --orange:#f59e0b; --red:#ef4444;
      --radius:16px; --shadow:0 12px 28px rgba(0,0,0,.35);
    }
    body{margin:0;background:linear-gradient(#0b1220,#0c1426);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto}
    .nav{position:sticky;top:0;background:rgba(12,18,32,.85);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06)}
    .nav .inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand img{width:28px;height:28px;border-radius:8px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:14px;cursor:pointer}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .kpi{font-size:28px;font-weight:800}
    .muted{color:var(--sub)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:var(--muted);cursor:pointer}
    .btn.primary{background:var(--blue)} .btn.danger{background:var(--red)} .btn.ghost{background:transparent}
    .right{text-align:right}
    canvas{width:100%;height:120px;background:#0d1324;border-radius:12px}
    .footer{opacity:.7;text-align:center;padding:18px}
  </style>
</head>
<body>

  <!-- Barra superior -->
  <div class="nav">
    <div class="inner">
      <div class="brand">
        <img src="assets/logo-guardian360.png" alt="Logo"/>
        <span>Guardi√°n 360</span>
        <span class="chip" id="userBadge">‚Äî</span>
      </div>
      <div class="chips">
        <button class="chip" data-go="emergencia">Emergencia</button>
        <button class="chip" data-go="trabajador">Trabajador</button>
        <button class="chip" data-go="entrenamiento">Entrenamiento</button>
        <button class="chip" data-go="sensores">Sensores</button>
        <button class="chip" data-go="mensajes">Mensajes</button>
        <button class="chip" data-go="reportes">Reportes</button>
        <button class="chip" onclick="doLogout()">Salir</button>
      </div>
    </div>
  </div>

  <!-- Contenido -->
  <main class="container">
    <div class="grid">
      <section class="card">
        <div class="muted">Incidentes hoy</div>
        <div class="kpi" id="kpiIncidentes">0</div>
        <canvas id="chartInc"></canvas>
        <div class="row" style="margin-top:10px">
          <button class="btn danger" id="panicBtn">üö® Bot√≥n de p√°nico</button>
          <button class="btn ghost" id="expInc">Exportar CSV</button>
        </div>
      </section>

      <section class="card">
        <div class="muted">% Cumplimiento ISO 45001</div>
        <div class="kpi" id="kpiComp">0%</div>
        <canvas id="chartComp"></canvas>
        <div class="muted" style="margin-top:8px">Actualiz√° en <a href="reportes.html">Reportes</a></div>
      </section>

      <section class="card">
        <div class="muted">Capacitaciones</div>
        <div class="kpi" id="kpiCaps">0/0</div>
        <div class="row" style="margin-top:8px">
          <a class="btn" href="entrenamiento.html">Abrir m√≥dulos</a>
        </div>
      </section>

      <section class="card">
        <div class="muted">Sensores activos</div>
        <div class="kpi" id="kpiSensores">0</div>
        <div id="sensSmall" class="row" style="margin-top:8px;gap:6px;flex-direction:column"></div>
        <canvas id="chartSens" style="margin-top:8px"></canvas>
      </section>
    </div>
  </main>

  <div class="footer">¬© 2025 Guardi√°n 360 ‚Äî Seguridad e Higiene</div>
</body>
</html>
```Ó®Å0Ó®Ç
