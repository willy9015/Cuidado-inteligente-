<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sensores ‚Äî Guardi√°n 360</title>
<link rel="icon" href="assets/logo-guardian360.png"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--card:#111827;--muted:#1f2937;--text:#f8fafc;--sub:#94a3b8;--green:#22c55e;--radius:16px;--shadow:0 12px 28px rgba(0,0,0,.35)}
body{margin:0;background:linear-gradient(#0b1220,#0c1426);color:var(--text);font-family:Inter,system-ui,Segoe UI}
.nav{position:sticky;top:0;background:rgba(12,18,32,.85);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06)}
.nav .inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}.brand img{width:28px;height:28px;border-radius:8px}
.container{max-width:1100px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0d1324;color:var(--text)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:var(--muted);cursor:pointer}
.btn.success{background:var(--green)}.btn.ghost{background:transparent}
.badge{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.08);color:var(--sub);font-size:12px}
canvas{width:100%;height:160px;background:#0d1324;border-radius:12px}
</style>
<script>
const S={sensors:JSON.parse(localStorage.getItem('g360_sensors')||'[]'),readings:JSON.parse(localStorage.getItem('g360_readings')||'[]')};
if(S.sensors.length===0){S.sensors=[{id:'s1',name:'CO‚ÇÇ',unit:'ppm',min:350,max:1500},{id:'s2',name:'Temp',unit:'¬∞C',min:10,max:45},{id:'s3',name:'Ruido',unit:'dB',min:0,max:85}];}
const $=(q,el=document)=>el.querySelector(q);
function save(){localStorage.setItem('g360_sensors',JSON.stringify(S.sensors));localStorage.setItem('g360_readings',JSON.stringify(S.readings));}
function addSensor(){
  const name=$("#sName").value.trim(), unit=$("#sUnit").value.trim(), min=+$("#sMin").value||0, max=+$("#sMax").value||100;
  if(!name||!unit) return alert("Completa nombre y unidad");
  S.sensors.push({id:crypto.randomUUID(),name,unit,min,max}); save(); $("#sName").value=$("#sUnit").value=$("#sMin").value=$("#sMax").value=""; render(); alert("Sensor agregado");
}
function latest(id){const arr=S.readings.filter(r=>r.id===id);return arr[arr.length-1];}
function render(){
  const list=$("#list"); list.innerHTML="";
  S.sensors.forEach(s=>{
    const r=latest(s.id); const val=r? r.val.toFixed(1):"‚Äî"; const ok=r? (r.val>=s.min&&r.val<=s.max):true;
    const div=document.createElement('div');div.className="row";div.style.alignItems="center";
    div.innerHTML=`<div class="badge">üìà</div><div style="flex:1"><b>${s.name}</b> <span class="badge">${s.unit}</span><div class="badge">Rango ${s.min}-${s.max}</div></div><div><b>${val}</b></div><div class="badge" style="border-color:${ok?'#22c55e':'#ef4444'}">${ok?'OK':'‚ö†'}</div>`;
    list.appendChild(div);
  });
  draw($("#chart"), (S.readings.slice(-60).map(r=>r.val)));
}
let timer;
function loop(){
  clearInterval(timer);
  timer=setInterval(()=>{
    S.sensors.forEach(s=>{
      const base=(s.min+s.max)/2, amp=(s.max-s.min)/2||25;
      const val=base+(Math.random()*amp*2-amp);
      S.readings.push({ts:Date.now(),id:s.id,val});
      if(S.readings.length>800) S.readings.shift();
    });
    save(); render();
  },2000);
}
function draw(c,data){
  const ctx=c.getContext('2d'); const w=c.width=c.clientWidth,h=c.height=c.clientHeight; ctx.clearRect(0,0,w,h);
  if(!data.length) return; const pad=10,min=Math.min(...data),max=Math.max(...data);
  ctx.strokeStyle="#334155";ctx.beginPath();ctx.moveTo(pad,h-pad);ctx.lineTo(w-pad,h-pad);ctx.stroke();
  ctx.strokeStyle="#34d399";ctx.lineWidth=2;ctx.beginPath();
  data.forEach((v,i)=>{const x=pad+i*((w-2*pad)/Math.max(1,data.length-1));const y=h-pad-((v-min)/(max-min||1))*(h-2*pad);i?ctx.lineTo(x,y):ctx.moveTo(x,y);});
  ctx.stroke();
}
function exportCSV(){
  const rows=[["fecha","sensor","valor","unidad"],...S.readings.map(r=>{const s=S.sensors.find(x=>x.id===r.id);return [new Date(r.ts).toISOString(),s?.name||r.id,r.val,s?.unit||""];})];
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n")],{type:"text/csv"}));a.download="g360_sensores.csv";a.click();URL.revokeObjectURL(a.href);
}
window.addEventListener('DOMContentLoaded',()=>{render();loop();});
</script>
</head>
<body>
<div class="nav"><div class="inner"><div class="brand"><img src="assets/logo-guardian360.png"><span>Guardi√°n 360</span></div><div class="row"><a class="badge" href="dashboard.html">‚Üê Volver</a></div></div></div>
<main class="container">
  <div class="grid">
    <section class="card">
      <h2>Agregar sensor</h2>
      <div class="row"><input id="sName" placeholder="CO‚ÇÇ / Temp / Ruido"><input id="sUnit" placeholder="ppm / ¬∞C / dB"></div>
      <div class="row"><input id="sMin" type="number" placeholder="M√≠n"><input id="sMax" type="number" placeholder="M√°x"></div>
      <div class="row" style="margin-top:8px"><button class="btn success" onclick="addSensor()">A√±adir</button><button class="btn ghost" onclick="exportCSV()">Exportar CSV</button></div>
    </section>
    <section class="card"><h2>Lecturas</h2><div id="list" class="row" style="flex-direction:column"></div></section>
    <section class="card"><h2>Gr√°fico</h2><canvas id="chart"></canvas></section>
  </div>
</main>
</body>
</html>
