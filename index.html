<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PRISMA ¬∑ Seguridad Inteligente</title>
<link rel="icon" href="logo-prisma.png"/>
<link rel="stylesheet" href="style.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="theme-auto">

<!-- SPLASH tipo Netflix -->
<div id="splash" class="splash">
  <div class="splash-center">
    <img src="logo-prisma.png" alt="PRISMA" class="splash-logo">
    <div class="splash-title">PRISMA</div>
    <div class="splash-sub">Seguridad Inteligente ¬∑ ISO 45001</div>
  </div>
  <div class="splash-gradient"></div>
</div>

<!-- NAV -->
<header class="nav">
  <div class="container nav-inner">
    <a class="brand" href="#/home">
      <img src="logo-prisma.png" class="brand-logo" alt="PRISMA">
      <div class="brand-meta"><strong>PRISMA</strong><small>Seguridad ¬∑ ISO 45001</small></div>
    </a>
    <nav class="menu only-desktop">
      <a href="#/dashboard" data-i18n="nav_dashboard">Dashboard</a>
      <a href="#/forms" data-i18n="nav_forms">Formularios</a>
      <a href="#/reports" data-i18n="nav_reports">Reportes</a>
      <a href="#/training" data-i18n="nav_training">Capacitaci√≥n</a>
      <a href="#/sensors" data-i18n="nav_sensors">Sensores</a>
      <a href="#/map" data-i18n="nav_map">Mapa</a>
      <a href="#/gamify" data-i18n="nav_gamify">Gamificaci√≥n</a>
    </nav>
    <div class="actions">
      <button id="langBtn" class="icon-btn">ES</button>
      <button id="themeBtn" class="icon-btn">üåû</button>
      <button id="loginBtn" class="btn outline js-open-login" data-i18n="login">Ingresar</button>
      <button id="logoutBtn" class="btn outline" style="display:none" data-i18n="logout">Salir</button>
      <button id="menuBtn" class="hamburger" aria-label="Menu" aria-expanded="false"><span></span><span></span><span></span></button>
    </div>
  </div>
  <nav id="mobileMenu" class="menu-panel">
    <a href="#/dashboard" data-i18n="nav_dashboard">Dashboard</a>
    <a href="#/forms" data-i18n="nav_forms">Formularios</a>
    <a href="#/reports" data-i18n="nav_reports">Reportes</a>
    <a href="#/training" data-i18n="nav_training">Capacitaci√≥n</a>
    <a href="#/sensors" data-i18n="nav_sensors">Sensores</a>
    <a href="#/map" data-i18n="nav_map">Mapa</a>
    <a href="#/gamify" data-i18n="nav_gamify">Gamificaci√≥n</a>
  </nav>
</header>

<!-- VISTAS SPA -->
<main id="app" class="container">

  <!-- HOME -->
  <section data-route="/home" class="route active">
    <div class="hero">
      <div class="hero-copy">
        <h1 data-i18n="hero_title">Seguridad inteligente para cero incidentes</h1>
        <p class="lead" data-i18n="hero_sub">Checklists, reportes, mapa de riesgos, bot√≥n de p√°nico, sensores y capacitaci√≥n con IA.</p>
        <div class="hero-ctas">
          <a class="btn primary" href="#/dashboard" data-i18n="open_dashboard">Abrir Dashboard</a>
          <button class="btn outline js-open-login" data-i18n="create_account">Crear cuenta</button>
        </div>
        <ul class="hero-badges"><li>ISO 45001</li><li data-i18n="offline_mode">Modo offline</li><li data-i18n="export_pdf">PDF/Excel</li></ul>
      </div>
      <aside class="hero-card">
        <h3 data-i18n="quick_actions">Acciones r√°pidas</h3>
        <div class="quick-list">
          <button class="quick" id="panicBtn"><span class="ic">üö®</span><span data-i18n="panic_button">Bot√≥n de p√°nico</span></button>
          <a class="quick" href="#/training"><span class="ic">üéß</span><span data-i18n="micro_courses">Microcursos IA</span></a>
          <a class="quick" href="#/sensors"><span class="ic">üì°</span><span data-i18n="sensors_rt">Sensores tiempo real</span></a>
        </div>
        <output id="panicOut" class="muted"></output>
      </aside>
    </div>
  </section>

  <!-- LOGIN/REGISTER (modal) -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeLogin()">‚úï</button>
      <div class="tabs">
        <button class="tab active" id="tabLogin" data-i18n="login">Ingresar</button>
        <button class="tab" id="tabSignup" data-i18n="signup">Crear cuenta</button>
      </div>
      <form id="formLogin" class="grid gap">
        <label class="stack"><span data-i18n="email">Email</span><input id="loginEmail" type="email" required></label>
        <label class="stack"><span data-i18n="password">Contrase√±a</span><input id="loginPass" type="password" required></label>
        <button class="btn primary full" type="submit" data-i18n="login">Ingresar</button>
        <button class="btn outline full" type="button" onclick="demoGoogle()" data-i18n="login_google">Continuar con Google</button>
        <a href="#" onclick="alert('Demo: reset');return false;" class="muted" data-i18n="forgot">¬øOlvidaste tu contrase√±a?</a>
      </form>
      <form id="formSignup" class="grid gap" style="display:none">
        <label class="stack"><span data-i18n="name">Nombre</span><input id="suName" required></label>
        <label class="stack"><span data-i18n="company">Empresa</span><input id="suCompany" required></label>
        <label class="stack"><span data-i18n="email">Email</span><input id="suEmail" type="email" required></label>
        <label class="stack"><span data-i18n="password">Contrase√±a</span><input id="suPass" type="password" minlength="6" required></label>
        <button class="btn primary full" type="submit" data-i18n="create_account">Crear cuenta</button>
      </form>
      <div id="authMsg" class="notice" style="display:none"></div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <section data-route="/dashboard" class="route">
    <h2>Dashboard</h2>
    <div class="kpi-row">
      <div class="kpi"><span data-i18n="kpi_incidents" class="kpi-label">Incidentes hoy</span><strong id="kInc">0</strong></div>
      <div class="kpi"><span data-i18n="kpi_compliance" class="kpi-label">% Cumplimiento</span><strong id="kCom">92%</strong></div>
      <div class="kpi"><span data-i18n="kpi_training" class="kpi-label">Capacitaciones</span><strong id="kTrain">17</strong></div>
      <div class="kpi"><span class="kpi-label">Alertas IA</span><strong id="kAI">3</strong></div>
    </div>
    <div class="grid two">
      <div class="card"><h3>Incidentes √∫ltimos 30 d√≠as</h3><canvas id="cInc" height="140"></canvas></div>
      <div class="card"><h3>Uso correcto de EPP (%)</h3><canvas id="cEpp" height="140"></canvas></div>
    </div>
  </section>

  <!-- FORMULARIOS (como tu captura) -->
  <section data-route="/forms" class="route">
    <h2 data-i18n="nav_forms">Formularios</h2>
    <div class="grid two">
      <aside class="card">
        <h3>Departamentos</h3>
        <div id="deptList" class="accordion"></div>
      </aside>
      <div class="card">
        <h3 id="formTitle">Selecciona un formulario</h3>
        <form id="dynamicForm" class="grid gap"></form>
        <div id="formMsg" class="notice" style="display:none"></div>
      </div>
    </div>
  </section>

  <!-- REPORTES -->
  <section data-route="/reports" class="route">
    <h2 data-i18n="nav_reports">Reportes</h2>
    <div class="card">
      <div class="row wrap">
        <input id="repFilter" class="input" placeholder="Buscar‚Ä¶">
        <button id="repNew" class="btn">Nuevo</button>
        <button id="repCSV" class="btn outline">Exportar CSV</button>
        <button id="repPDF" class="btn outline">Imprimir PDF</button>
      </div>
      <div style="overflow:auto">
        <table class="table" id="repTable">
          <thead><tr><th>Fecha</th><th>√Årea</th><th>Tipo</th><th>Estado</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- CAPACITACI√ìN -->
  <section data-route="/training" class="route">
    <h2 data-i18n="nav_training">Capacitaci√≥n</h2>
    <div class="grid three">
      <div class="card">
        <h3>Trabajo en altura</h3>
        <p class="muted">Microcurso 6 min ¬∑ voz IA</p>
        <button class="btn" onclick="startCourse('altura')">Iniciar</button>
        <progress id="p_altura" max="100" value="0"></progress>
      </div>
      <div class="card">
        <h3>Espacios confinados</h3>
        <p class="muted">Microcurso 8 min ¬∑ voz IA</p>
        <button class="btn" onclick="startCourse('confinado')">Iniciar</button>
        <progress id="p_confinado" max="100" value="0"></progress>
      </div>
      <div class="card">
        <h3>Energ√≠a el√©ctrica</h3>
        <p class="muted">Microcurso 5 min ¬∑ voz IA</p>
        <button class="btn" onclick="startCourse('electrico')">Iniciar</button>
        <progress id="p_electrico" max="100" value="0"></progress>
      </div>
    </div>
  </section>

  <!-- SENSORES -->
  <section data-route="/sensors" class="route">
    <h2 data-i18n="nav_sensors">Sensores</h2>
    <div class="grid two">
      <div class="card">
        <h3>Lecturas</h3>
        <div class="row wrap gap" id="sensorChips"></div>
      </div>
      <div class="card">
        <h3>Umbrales</h3>
        <div class="grid two">
          <label class="stack">CO‚ÇÇ max (ppm)<input id="thCO2" type="number" class="input" value="900"/></label>
          <label class="stack">Ruido max (dB)<input id="thDB" type="number" class="input" value="85"/></label>
        </div>
        <button class="btn" onclick="saveThresholds()">Guardar umbrales</button>
      </div>
    </div>
  </section>

  <!-- MAPA RIESGOS -->
  <section data-route="/map" class="route">
    <h2 data-i18n="nav_map">Mapa de riesgos</h2>
    <div class="card">
      <canvas id="riskMap" width="900" height="420" style="max-width:100%"></canvas>
      <p class="muted">Rojo=alto riesgo, Amarillo=medio, Verde=bajo (simulado).</p>
    </div>
  </section>

  <!-- GAMIFICACI√ìN -->
  <section data-route="/gamify" class="route">
    <h2 data-i18n="nav_gamify">Gamificaci√≥n</h2>
    <div class="grid two">
      <div class="card">
        <h3>Puntaje</h3>
        <p>Tu puntaje actual: <strong id="pts">0</strong></p>
        <div class="row"><button class="btn" onclick="claimBadge()">Reclamar badge</button><div id="badgeOut" class="muted"></div></div>
      </div>
      <div class="card">
        <h3>Ranking</h3>
        <ol id="ranking"></ol>
      </div>
    </div>
  </section>

</main>

<footer class="footer">
  <div class="container footer-grid">
    <div class="brand small">
      <img src="logo-prisma.png" class="brand-logo" alt="PRISMA">
      <div class="brand-meta"><strong>PRISMA</strong><small>Seguridad & Higiene</small></div>
    </div>
    <div class="footer-links">
      <a href="#/reports">Reportes</a>
      <a href="#/forms">Formularios</a>
      <a href="#/dashboard">Dashboard</a>
    </div>
  </div>
</footer>

<script>
/* ====== i18n ====== */
const dict={es:{nav_dashboard:"Dashboard",nav_forms:"Formularios",nav_reports:"Reportes",nav_training:"Capacitaci√≥n",nav_sensors:"Sensores",nav_map:"Mapa",nav_gamify:"Gamificaci√≥n",
hero_title:"Seguridad inteligente para cero incidentes",hero_sub:"Checklists, reportes, mapa de riesgos, bot√≥n de p√°nico, sensores y capacitaci√≥n con IA.",
open_dashboard:"Abrir Dashboard",create_account:"Crear cuenta",offline_mode:"Modo offline",export_pdf:"Exportaci√≥n PDF/Excel",
quick_actions:"Acciones r√°pidas",panic_button:"Bot√≥n de p√°nico",micro_courses:"Microcursos IA",sensors_rt:"Sensores tiempo real",
email:"Email",password:"Contrase√±a",login:"Ingresar",signup:"Crear cuenta",login_google:"Continuar con Google",forgot:"¬øOlvidaste tu contrase√±a?",
name:"Nombre",company:"Empresa",logout:"Salir"},
en:{nav_dashboard:"Dashboard",nav_forms:"Forms",nav_reports:"Reports",nav_training:"Training",nav_sensors:"Sensors",nav_map:"Map",nav_gamify:"Gamification",
hero_title:"Smart safety for zero incidents",hero_sub:"Checklists, incident reports, risk map, panic button, sensors and AI training.",
open_dashboard:"Open Dashboard",create_account:"Create account",offline_mode:"Offline mode",export_pdf:"PDF/Excel export",
quick_actions:"Quick actions",panic_button:"Panic button",micro_courses:"AI microcourses",sensors_rt:"Real-time sensors",
email:"Email",password:"Password",login:"Sign in",signup:"Sign up",login_google:"Continue with Google",forgot:"Forgot your password?",
name:"Name",company:"Company",logout:"Sign out"}};
const langBtn=document.getElementById('langBtn');
function applyLang(l){document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(dict[l][k])el.textContent=dict[l][k];});langBtn.textContent=l.toUpperCase();localStorage.setItem('lang',l);document.documentElement.lang=l;}
langBtn.addEventListener('click',()=>applyLang((localStorage.getItem('lang')||'es')==='es'?'en':'es'));
applyLang(localStorage.getItem('lang')||'es');

/* ====== theme ====== */
const themeBtn=document.getElementById('themeBtn');
function applyTheme(t){document.body.classList.remove('theme-light','theme-dark','theme-auto');document.body.classList.add(t);themeBtn.textContent=t==='theme-dark'?'üåô':'üåû';localStorage.setItem('theme',t);}
themeBtn.addEventListener('click',()=>applyTheme((localStorage.getItem('theme')||'theme-auto')==='theme-dark'?'theme-light':'theme-dark'));
applyTheme(localStorage.getItem('theme')||'theme-auto');

/* ====== splash ====== */
const splash=document.getElementById('splash');
setTimeout(()=>{splash.classList.add('hide');openLogin();},1800);

/* ====== router ====== */
const routes=[...document.querySelectorAll('.route')];
function go(hash){const r=hash.replace('#','')||'#/home';routes.forEach(s=>s.classList.remove('active'));const el=document.querySelector(`[data-route="${r.slice(1)}"]`);if(el)el.classList.add('active');}
window.addEventListener('hashchange',()=>go(location.hash));
go(location.hash||'#/home');

/* ====== mobile menu ====== */
const menuBtn=document.getElementById('menuBtn');const mobileMenu=document.getElementById('mobileMenu');
menuBtn.addEventListener('click',()=>mobileMenu.classList.toggle('open'));

/* ====== auth (local) ====== */
const loginBtn=document.getElementById('loginBtn'),logoutBtn=document.getElementById('logoutBtn');
const loginModal=document.getElementById('loginModal'),tabLogin=document.getElementById('tabLogin'),tabSignup=document.getElementById('tabSignup');
const formLogin=document.getElementById('formLogin'),formSignup=document.getElementById('formSignup'),authMsg=document.getElementById('authMsg');
function openLogin(){loginModal.classList.add('show');}
function closeLogin(){loginModal.classList.remove('show');}
document.querySelectorAll('.js-open-login').forEach(b=>b.addEventListener('click',openLogin));
tabLogin.onclick=()=>{tabLogin.classList.add('active');tabSignup.classList.remove('active');formLogin.style.display='grid';formSignup.style.display='none';authMsg.style.display='none';}
tabSignup.onclick=()=>{tabSignup.classList.add('active');tabLogin.classList.remove('active');formLogin.style.display='none';formSignup.style.display='grid';authMsg.style.display='none';}
formLogin.onsubmit=(e)=>{e.preventDefault();const email=document.getElementById('loginEmail').value;localStorage.setItem('session',JSON.stringify({email,name:'Usuario'}));loginBtn.style.display='none';logoutBtn.style.display='inline-flex';closeLogin();location.hash='#/dashboard';};
formSignup.onsubmit=(e)=>{e.preventDefault();const name=document.getElementById('suName').value;const email=document.getElementById('suEmail').value;localStorage.setItem('session',JSON.stringify({email,name}));loginBtn.style.display='none';logoutBtn.style.display='inline-flex';authMsg.textContent='Cuenta creada (demo).';authMsg.style.display='block';setTimeout(closeLogin,700);location.hash='#/dashboard';};
logoutBtn.onclick=()=>{localStorage.removeItem('session');loginBtn.style.display='inline-flex';logoutBtn.style.display='none';location.hash='#/home';};

/* ====== panic ====== */
const panicBtn=document.getElementById('panicBtn');const panicOut=document.getElementById('panicOut');
if(panicBtn){panicBtn.onclick=()=>{panicOut.textContent='...';if(!navigator.geolocation){panicOut.textContent='No soportado';return;}
navigator.geolocation.getCurrentPosition(p=>{const {latitude,longitude}=p.coords;panicOut.textContent=`Alerta enviada ¬∑ ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;/* TODO: API */},err=>panicOut.textContent='Error: '+err.message,{enableHighAccuracy:true,timeout:8000});};}

/* ====== dashboard charts ====== */
function sparkCharts(){
const incCtx=document.getElementById('cInc'); if(incCtx){new Chart(incCtx,{type:'bar',data:{labels:Array.from({length:30},(_,i)=>i+1),datasets:[{label:'Incidentes',data:Array.from({length:30},()=>Math.floor(Math.random()*4)),backgroundColor:'#60a5fa'}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});}
const eppCtx=document.getElementById('cEpp'); if(eppCtx){new Chart(eppCtx,{type:'line',data:{labels:['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'],datasets:[{label:'Cascos',data:[92,95,93,96,94,97,95],borderColor:'#10b981'},{label:'Guantes',data:[88,90,91,92,90,93,94],borderColor:'#2563eb'}]},options:{responsive:true}});}
}
sparkCharts();

/* ====== Formularios (departamentos + contadores) ====== */
const DEPTS=[{name:'Calidad',forms:[{id:'reclamos',title:'Reclamos',fields:[{k:'descripcion',t:'text',label:'Descripci√≥n'},{k:'evidencia',t:'file',label:'Evidencia'}]},{id:'insumos',title:'Insumos',fields:[{k:'insumo',t:'text',label:'Insumo'},{k:'cantidad',t:'number',label:'Cantidad'}]}]},{name:'Auditor√≠as',forms:[{id:'stop',title:'Auditor√≠a STOP',fields:[{k:'area',t:'text',label:'√Årea'},{k:'hallazgo',t:'text',label:'Hallazgo'}]},{id:'extintores',title:'Extintores',fields:[{k:'codigo',t:'text',label:'C√≥digo'},{k:'vencimiento',t:'date',label:'Vencimiento'}]}]},{name:'Seguridad',forms:[{id:'permiso',title:'Permiso de trabajo',fields:[{k:'tarea',t:'text',label:'Tarea'},{k:'riesgo',t:'select',label:'Riesgo',opts:['Alto','Medio','Bajo']}]}]}];
const LS_FORMS='prisma_forms';
function loadFormStore(){return JSON.parse(localStorage.getItem(LS_FORMS)||'{}');}
function saveFormStore(s){localStorage.setItem(LS_FORMS,JSON.stringify(s));}
function countForm(id){const s=loadFormStore();return (s[id]||[]).length;}
function renderDepts(){
  const wrap=document.getElementById('deptList'); if(!wrap) return; wrap.innerHTML='';
  DEPTS.forEach(d=>{
    const div=document.createElement('div');div.className='acc';
    const head=document.createElement('button');head.className='acc-head';head.textContent=d.name;head.onclick=()=>div.classList.toggle('open');div.appendChild(head);
    const list=document.createElement('div');list.className='acc-body';
    d.forms.forEach(f=>{
      const a=document.createElement('a');a.href='javascript:void(0)';a.className='acc-item';
      a.innerHTML=`<span>${f.title}</span><span class="chip">${countForm(f.id)}</span>`;
      a.onclick=()=>openForm(f);list.appendChild(a);
    });
    div.appendChild(list);wrap.appendChild(div);
  });
}
function openForm(f){
  document.getElementById('formTitle').textContent=f.title;
  const form=document.getElementById('dynamicForm'); form.innerHTML='';
  f.fields.forEach(fd=>{
    const label=document.createElement('label');label.className='stack';label.innerHTML=`<span>${fd.label}</span>`;
    let input;
    if(fd.t==='select'){input=document.createElement('select');fd.opts.forEach(o=>{const op=document.createElement('option');op.value=o;op.textContent=o;input.appendChild(op);});}
    else{input=document.createElement('input');input.type=fd.t;}
    input.className='input'; input.id=`f_${fd.k}`; label.appendChild(input); form.appendChild(label);
  });
  const btn=document.createElement('button');btn.className='btn';btn.textContent='Enviar';
  btn.onclick=()=>{const s=loadFormStore();const row={fecha:new Date().toISOString(),form:f.id};f.fields.forEach(fd=>{row[fd.k]=document.getElementById(`f_${fd.k}`).value;});s[f.id]=s[f.id]||[];s[f.id].push(row);saveFormStore(s);document.getElementById('formMsg').textContent='Enviado ‚úî';document.getElementById('formMsg').style.display='block';renderDepts();};
  form.appendChild(btn);
}
renderDepts();

/* ====== Reportes ====== */
const LS_REP='prisma_reports';
function repStore(){return JSON.parse(localStorage.getItem(LS_REP)||'[]');}
function repSave(v){localStorage.setItem(LS_REP,JSON.stringify(v));}
function renderReports(){
  const tbody=document.querySelector('#repTable tbody'); if(!tbody) return;
  const q=(document.getElementById('repFilter').value||'').toLowerCase();
  tbody.innerHTML=''; repStore().filter(r=>JSON.stringify(r).toLowerCase().includes(q)).forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.fecha.slice(0,16).replace('T',' ')}</td><td>${r.area}</td><td>${r.tipo}</td><td>${r.estado}</td>
    <td><button class="btn outline" onclick="delRep(${i})">Borrar</button></td>`;
    tbody.appendChild(tr);
  });
}
function delRep(i){const v=repStore();v.splice(i,1);repSave(v);renderReports();}
document.getElementById('repNew').onclick=()=>{const v=repStore();v.push({fecha:new Date().toISOString(),area:'General',tipo:'Incidente',estado:'Abierto'});repSave(v);renderReports();};
document.getElementById('repFilter').oninput=renderReports;
document.getElementById('repCSV').onclick=()=>{const rows=[['fecha','area','tipo','estado'],...repStore().map(r=>[r.fecha,r.area,r.tipo,r.estado])];const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download='reportes.csv';a.click();};
document.getElementById('repPDF').onclick=()=>{window.print();};
renderReports();

/* ====== Training ====== */
function startCourse(id){const p=document.getElementById(`p_${id}`);let v=0;const t=setInterval(()=>{v+=10;p.value=v;if(v>=100){clearInterval(t);addPoints(50);} },250);}

/* ====== Sensores ====== */
const sensorChips=document.getElementById('sensorChips');
function rnd(n1,n2){return Math.round(n1+Math.random()*(n2-n1));}
function renderSensors(){ if(!sensorChips) return;
  const th=loadThresholds(); const co2=rnd(420,1100), temp=rnd(18,34), ruido=rnd(55,98);
  const items=[['CO‚ÇÇ',co2,'ppm',co2>th.co2],['Temp',temp,'¬∞C',temp>30],['Ruido',ruido,'dB',ruido>th.db]];
  sensorChips.innerHTML=''; items.forEach(([k,v,u,alert])=>{const div=document.createElement('div');div.className='chip '+(alert?'red':'');div.innerHTML=`${k} <strong>${v} ${u}</strong>`;sensorChips.appendChild(div);});
}
function loadThresholds(){return JSON.parse(localStorage.getItem('prisma_th')||'{"co2":900,"db":85}');}
function saveThresholds(){localStorage.setItem('prisma_th',JSON.stringify({co2:+document.getElementById('thCO2').value,db:+document.getElementById('thDB').value}));alert('Umbrales guardados');}
setInterval(renderSensors,1500); renderSensors();

/* ====== Mapa riesgos ====== */
function drawMap(){const c=document.getElementById('riskMap'); if(!c) return; const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  for(let x=0;x<c.width;x+=45){for(let y=0;y<c.height;y+=45){const r=Math.random();ctx.fillStyle=r>0.8?'#ef4444':r>0.5?'#f59e0b':'#22c55e';ctx.fillRect(x+2,y+2,40,40);}}
}
drawMap();

/* ====== Gamificaci√≥n ====== */
function addPoints(n){const pts=+localStorage.getItem('pts')||0;localStorage.setItem('pts',pts+n);document.getElementById('pts').textContent=pts+n;}
function claimBadge(){addPoints(10);document.getElementById('badgeOut').textContent='Badge obtenido ‚úî';}
function renderRanking(){const r=document.getElementById('ranking');if(!r) return; const base=['Equipo Norte','Equipo Sur','Planta A','Planta B']; r.innerHTML=''; base.sort(()=>Math.random()-.5).forEach((n,i)=>{const li=document.createElement('li');li.textContent=`${n} ‚Äî ${100-i*7} pts`;r.appendChild(li);});}
document.getElementById('pts').textContent=localStorage.getItem('pts')||0; renderRanking();

/* ====== KPIs ====== */
document.getElementById('kInc').textContent = (JSON.parse(localStorage.getItem('prisma_inc')||'[]')).length || 0;

/* ====== Google demo ====== */
function demoGoogle(){alert('Demo UI: Google OAuth. (Sustituir por Supabase/Firebase)');}

/* ====== Sesi√≥n persistente ====== */
(function initSession(){
  const s=localStorage.getItem('session'); if(s){loginBtn.style.display='none';logoutBtn.style.display='inline-flex';}
})();
</script>
</body>
</html>
