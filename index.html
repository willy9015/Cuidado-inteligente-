<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guardi√°n 360 ‚Äî Seguridad e Higiene</title>
  <link rel="icon" href="assets/logo-guardian360.png" />
  <meta name="theme-color" content="#0b1220" />

  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#111827; --muted:#1f2937;
      --text:#f8fafc; --sub:#94a3b8;
      --blue:#2563eb; --green:#22c55e; --orange:#f97316; --red:#ef4444;
      --radius:16px; --shadow:0 14px 34px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:linear-gradient(#0b1220,#0c1426);color:var(--text);
         font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    a{color:inherit;text-decoration:none}
    .container{max-width:1080px;margin:0 auto;padding:18px}
    /* header */
    .nav{position:sticky;top:0;z-index:40;background:rgba(12,18,32,.85);backdrop-filter:blur(10px);
         border-bottom:1px solid rgba(255,255,255,.06)}
    .nav .inner{display:flex;align-items:center;justify-content:space-between;padding:14px 10px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800}
    .brand img{width:32px;height:32px;border-radius:8px;box-shadow:var(--shadow)}
    .nav .menu{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.08);
         background:var(--muted);cursor:pointer;box-shadow:var(--shadow)}
    .btn.ghost{background:transparent}
    .btn.primary{background:var(--blue)}
    .btn.success{background:var(--green)}
    .btn.danger{background:var(--red)}
    .btn.full{width:100%;justify-content:center}
    /* views */
    .views{padding:14px}
    .view{display:none}
    .view.active{display:block}
    /* hero + big menu */
    .hero{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);
          padding:18px;box-shadow:var(--shadow);margin:16px 0}
    .hero h1{margin:0 0 8px;font-size:24px}
    .bigmenu{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .tile{display:flex;align-items:center;gap:14px;background:var(--card);border:1px solid rgba(255,255,255,.06);
          padding:18px;border-radius:16px}
    .icon{width:40px;height:40px;display:grid;place-items:center;border-radius:12px;background:rgba(255,255,255,.06)}
    .tile .title{font-weight:700}
    .tile .desc{font-size:13px;color:var(--sub)}
    /* cards / grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .kpi{font-size:28px;font-weight:800}
    .muted{color:var(--sub)}
    /* forms */
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0d1324;color:var(--text)}
    label{font-size:13px;color:var(--sub)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .list{display:flex;flex-direction:column;gap:10px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.08);color:var(--sub)}
    .table{width:100%;border-collapse:collapse;background:var(--panel);border-radius:12px;overflow:hidden}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    .right{text-align:right}
    .footer{text-align:center;opacity:.7;padding:20px}
    .toast{position:fixed;inset:auto 16px 16px auto;background:#111827;color:#fff;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);display:none}
    canvas{width:100%;height:140px;background:#0d1324;border-radius:12px}
    @media(min-width:900px){.bigmenu{flex-direction:row;flex-wrap:wrap}.tile{width:calc(50% - 6px)}}
  </style>
</head>

<body>
  <!-- TOP BAR -->
  <div class="nav">
    <div class="container inner">
      <div class="brand">
        <!-- Reemplaz√° este archivo por tu logo PNG con el MISMO nombre -->
        <img src="assets/logo-guardian360.png" alt="Logo Guardi√°n 360" />
        <span>Guardi√°n 360</span>
        <span class="chip">ISO 45001</span>
      </div>
      <div class="menu">
        <button class="chip" data-go="dashboard">Dashboard</button>
        <button class="chip" data-go="emergencia">Emergencia</button>
        <button class="chip" data-go="trabajador">Trabajador</button>
        <button class="chip" data-go="entrenamiento">Entrenamiento</button>
        <button class="chip" data-go="sensores">Sensores</button>
        <button class="chip" data-go="mensajes">Mensajes</button>
        <button class="chip" data-go="reportes">Reportes</button>
        <button class="chip" data-go="ajustes">Ajustes</button>
      </div>
    </div>
  </div>

  <div class="container views">

    <!-- DASHBOARD -->
    <section id="dashboard" class="view active">
      <div class="hero">
        <h1>Resumen en tiempo real</h1>
        <p class="muted">Incidentes, cumplimiento, capacitaci√≥n y sensores activos.</p>
        <div class="bigmenu">
          <a class="tile" href="#emergencia" onclick="go('emergencia')">
            <div class="icon">üö®</div>
            <div><div class="title">Emergencia</div><div class="desc">Bot√≥n de p√°nico con GPS y alerta</div></div>
          </a>
          <a class="tile" href="#trabajador" onclick="go('trabajador')">
            <div class="icon">üë∑</div>
            <div><div class="title">Estado del trabajador</div><div class="desc">Check-in, EPP y fatiga</div></div>
          </a>
          <a class="tile" href="#entrenamiento" onclick="go('entrenamiento')">
            <div class="icon">üéß</div>
            <div><div class="title">Entrenamiento</div><div class="desc">Microcursos + voz</div></div>
          </a>
          <a class="tile" href="#sensores" onclick="go('sensores')">
            <div class="icon">üå°Ô∏è</div>
            <div><div class="title">Sensores</div><div class="desc">Lecturas y l√≠mites</div></div>
          </a>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="muted">Incidentes hoy</div>
          <div class="kpi" id="kpiIncidentes">0</div>
          <canvas id="chartInc"></canvas>
        </div>
        <div class="card">
          <div class="muted">% Cumplimiento</div>
          <div class="kpi" id="kpiCompliance">0%</div>
          <canvas id="chartComp"></canvas>
        </div>
        <div class="card">
          <div class="muted">Capacitaciones</div>
          <div class="kpi"><span id="kpiCapsOk">0</span>/<span id="kpiCapsTot">0</span></div>
          <div class="badge" id="badgeCap">Sin iniciar</div>
        </div>
        <div class="card">
          <div class="muted">Sensores activos</div>
          <div class="kpi" id="kpiSensores">0</div>
          <div class="list" id="listSensoresSmall"></div>
        </div>
      </div>
    </section>

    <!-- EMERGENCIA -->
    <section id="emergencia" class="view">
      <div class="grid">
        <div class="card">
          <h3>Bot√≥n de p√°nico</h3>
          <p class="muted">Env√≠a alerta inmediata con ubicaci√≥n y hora.</p>
          <div class="row">
            <button class="btn danger full" onclick="triggerEmergency()">üî¥ Activar emergencia</button>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn ghost" onclick="navigator.vibrate?.([80,30,80])">Probar vibraci√≥n</button>
            <button class="btn" onclick="shareLastIncident()">Compartir √∫ltimo</button>
            <button class="btn" onclick="exportCSV('incidentes')">Exportar CSV</button>
          </div>
        </div>

        <div class="card">
          <h3>Incidentes registrados</h3>
          <table class="table" id="tablaIncidentes">
            <thead><tr><th>Fecha</th><th>Tipo</th><th>Ubicaci√≥n</th><th class="right">Severidad</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TRABAJADOR -->
    <section id="trabajador" class="view">
      <div class="grid">
        <div class="card">
          <h3>Check-in del trabajador</h3>
          <div class="row">
            <div><label>Nombre</label><input id="wName" placeholder="Juan P√©rez"></div>
            <div><label>Rol</label><input id="wRole" placeholder="Operario / Supervisor"></div>
          </div>
          <div class="row">
            <div><label>Fatiga (0‚Äì10)</label><input id="wFatigue" type="range" min="0" max="10" value="3" oninput="fatigueOut.textContent=this.value"><div class="muted">Nivel: <b id="fatigueOut">3</b></div></div>
            <div><label>Frecuencia card√≠aca</label><input id="wHR" type="number" placeholder="bpm"></div>
          </div>
          <div class="row">
            <div>
              <label>EPP</label>
              <div class="list">
                <label><input type="checkbox" class="epp" value="Casco"> Casco</label>
                <label><input type="checkbox" class="epp" value="Guantes"> Guantes</label>
                <label><input type="checkbox" class="epp" value="Botas"> Botas</label>
                <label><input type="checkbox" class="epp" value="Lentes"> Lentes</label>
              </div>
            </div>
            <div>
              <label>Tipo de tarea</label>
              <select id="wJob">
                <option>Altura</option><option>El√©ctrica</option><option>Espacio confinado</option><option>Caliente</option>
              </select>
              <div style="margin-top:8px" class="row">
                <button class="btn" onclick="genQR()">Generar QR</button>
                <button class="btn ghost" onclick="scanQR()">Escanear</button>
              </div>
              <img id="qrImg" style="margin-top:8px;border-radius:10px;max-width:180px;display:none" alt="QR tarea"/>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn success" onclick="saveWorker()">Registrar ingreso</button>
            <button class="btn ghost" onclick="exportCSV('workers')">Exportar CSV</button>
          </div>
        </div>

        <div class="card">
          <h3>√öltimos registros</h3>
          <table class="table" id="tablaWorkers">
            <thead><tr><th>Fecha</th><th>Nombre</th><th>Rol</th><th>EPP</th><th>Fatiga</th><th>Tarea</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ENTRENAMIENTO -->
    <section id="entrenamiento" class="view">
      <div class="grid">
        <div class="card">
          <h3>M√≥dulos</h3>
          <div class="list" id="modulosList"></div>
          <div class="row" style="margin-top:10px">
            <button class="btn" onclick="startVoice()">üéôÔ∏è Voz</button>
            <button class="btn ghost" onclick="stopVoice()">Detener</button>
          </div>
        </div>

        <div class="card">
          <h3>Chat de capacitaci√≥n</h3>
          <div id="chatBox" style="height:260px;overflow:auto;background:#0d1324;border-radius:12px;padding:10px"></div>
          <div class="row" style="margin-top:8px">
            <input id="chatInput" placeholder="Pregunta sobre seguridad..." onkeydown="if(event.key==='Enter')sendChat()">
            <button class="btn primary" onclick="sendChat()">Enviar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SENSORES -->
    <section id="sensores" class="view">
      <div class="grid">
        <div class="card">
          <h3>Agregar sensor</h3>
          <div class="row">
            <input id="sName" placeholder="CO‚ÇÇ / Temp / Ruido">
            <input id="sUnit" placeholder="ppm / ¬∞C / dB">
          </div>
          <div class="row">
            <input id="sMin" type="number" placeholder="M√≠n">
            <input id="sMax" type="number" placeholder="M√°x">
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn success" onclick="addSensor()">A√±adir</button>
            <button class="btn ghost" onclick="exportCSV('sensors')">Exportar CSV</button>
          </div>
        </div>

        <div class="card">
          <h3>Lecturas</h3>
          <div id="sensoresList" class="list"></div>
        </div>

        <div class="card">
          <h3>Gr√°fico</h3>
          <canvas id="chartSens"></canvas>
        </div>
      </div>
    </section>

    <!-- MENSAJES -->
    <section id="mensajes" class="view">
      <div class="grid">
        <div class="card">
          <h3>Mensajer√≠a interna</h3>
          <div id="msgs" style="height:280px;overflow:auto;background:#0d1324;border-radius:12px;padding:10px"></div>
          <div class="row" style="margin-top:8px">
            <input id="msgText" placeholder="Escribe un mensaje..." onkeydown="if(event.key==='Enter')sendMsg()">
            <button class="btn primary" onclick="sendMsg()">Enviar</button>
            <button class="btn ghost" onclick="exportCSV('messages')">Exportar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- REPORTES -->
    <section id="reportes" class="view">
      <div class="grid">
        <div class="card">
          <h3>Auditor√≠a ISO 45001</h3>
          <div class="list">
            <label><input type="checkbox" class="chkIso"> Liderazgo y compromiso</label>
            <label><input type="checkbox" class="chkIso"> Identificaci√≥n de peligros</label>
            <label><input type="checkbox" class="chkIso"> Competencia y capacitaci√≥n</label>
            <label><input type="checkbox" class="chkIso"> Preparaci√≥n ante emergencias</label>
            <label><input type="checkbox" class="chkIso"> Evaluaci√≥n del desempe√±o</label>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" onclick="print()">Generar PDF</button>
            <button class="btn ghost" onclick="calcCompliance()">Calcular cumplimiento</button>
          </div>
        </div>

        <div class="card">
          <h3>Resumen</h3>
          <table class="table">
            <tbody>
              <tr><td>Incidentes hoy</td><td class="right" id="sumInc">0</td></tr>
              <tr><td>Capacitaciones completas</td><td class="right" id="sumCap">0</td></tr>
              <tr><td>Sensores activos</td><td class="right" id="sumSen">0</td></tr>
              <tr><td>% Cumplimiento</td><td class="right" id="sumComp">0%</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- AJUSTES -->
    <section id="ajustes" class="view">
      <div class="grid">
        <div class="card">
          <h3>Empresa</h3>
          <div class="row">
            <input id="cName" placeholder="Nombre de la empresa">
            <input id="cSite" placeholder="Sitio / Planta">
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn success" onclick="saveCompany()">Guardar</button>
            <button class="btn ghost" onclick="resetAll()">Reiniciar datos</button>
          </div>
        </div>

        <div class="card">
          <h3>Estado del sistema</h3>
          <div class="list">
            <div>Modo offline: <span class="badge" id="offlineBadge">No</span></div>
            <div>Geolocalizaci√≥n: <span class="badge" id="geoBadge">Pendiente</span></div>
            <div>Voz: <span class="badge" id="voiceBadge">No activo</span></div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <div class="toast" id="toast"></div>
  <div class="footer">¬© 2025 Guardi√°n 360 ‚Äî Seguridad e Higiene</div>

  <script>
    /* ========= Estado y helpers ========= */
    const S = {
      incidents: JSON.parse(localStorage.getItem('g360_inc')||'[]'),
      workers:   JSON.parse(localStorage.getItem('g360_workers')||'[]'),
      sensors:   JSON.parse(localStorage.getItem('g360_sensors')||'[]'),
      readings:  JSON.parse(localStorage.getItem('g360_readings')||'[]'),
      messages:  JSON.parse(localStorage.getItem('g360_msgs')||'[]'),
      caps:      JSON.parse(localStorage.getItem('g360_caps')||'[]'),
      company:   JSON.parse(localStorage.getItem('g360_company')||'{}'),
      compliance: +localStorage.getItem('g360_comp')||0
    };

    const $ = (q, el=document)=>el.querySelector(q);
    const $$ = (q, el=document)=>[...el.querySelectorAll(q)];
    const toast = (t)=>{ const el=$("#toast"); el.textContent=t; el.style.display="block"; setTimeout(()=>el.style.display="none",2200); };
    const now = ()=> new Date().toLocaleString();

    function saveAll(){
      localStorage.setItem('g360_inc', JSON.stringify(S.incidents));
      localStorage.setItem('g360_workers', JSON.stringify(S.workers));
      localStorage.setItem('g360_sensors', JSON.stringify(S.sensors));
      localStorage.setItem('g360_readings', JSON.stringify(S.readings));
      localStorage.setItem('g360_msgs', JSON.stringify(S.messages));
      localStorage.setItem('g360_caps', JSON.stringify(S.caps));
      localStorage.setItem('g360_company', JSON.stringify(S.company));
      localStorage.setItem('g360_comp', S.compliance);
      renderAll();
    }

    /* ========= Router ========= */
    function go(view){
      $$(".view").forEach(v=>v.classList.remove("active"));
      $("#"+view)?.classList.add("active");
      location.hash = view;
      if(view==="sensores") kickSensorsLoop();
    }
    window.addEventListener('hashchange', ()=>go(location.hash.replace('#','')||'dashboard'));
    const startView = location.hash.replace('#','') || 'dashboard';
    go(startView);

    /* ========= Dashboard ========= */
    function renderDashboard(){
      $("#kpiIncidentes").textContent = S.incidents.filter(i=>isToday(i.ts)).length;
      $("#kpiSensores").textContent = S.sensors.length;
      $("#sumInc").textContent = S.incidents.length;
      $("#sumSen").textContent = S.sensors.length;

      const done = S.caps.filter(c=>c.done).length;
      $("#kpiCapsOk").textContent = done; $("#kpiCapsTot").textContent = S.caps.length;
      $("#sumCap").textContent = done;

      $("#kpiCompliance").textContent = S.compliance.toFixed(0)+"%";
      $("#sumComp").textContent = S.compliance.toFixed(0)+"%";

      // small sensores list
      const small = $("#listSensoresSmall"); small.innerHTML="";
      S.sensors.slice(0,4).forEach(s=>{
        const r = latestReading(s.id);
        const ok = r ? (r.val>=s.min && r.val<=s.max) : true;
        const div = document.createElement('div');
        div.innerHTML = `<span class="badge">${s.name}</span> ${r? r.val.toFixed(1)+' '+s.unit:'‚Äî'} <span class="badge" style="border-color:${ok?'#22c55e':'#ef4444'}">${ok?'OK':'‚ö†'}</span>`;
        small.appendChild(div);
      });

      drawLine($("#chartInc"), lastN(S.incidents.map((i,idx)=>idx+1), 12));
      drawLine($("#chartComp"), lastN(new Array(12).fill(0).map((_,i)=> Math.max(40, Math.min(100, S.compliance + (Math.random()*10-5)))),12));
    }

    function isToday(ts){ const d=new Date(ts); const t=new Date(); return d.toDateString()===t.toDateString(); }
    function lastN(arr,n){ return arr.slice(-n); }

    /* ========= Emergencia ========= */
    async function triggerEmergency(){
      let loc = "sin GPS";
      try{
        $("#geoBadge").textContent="Solicitando‚Ä¶";
        const pos = await new Promise((res,rej)=>navigator.geolocation?
          navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:7000}):rej("no geo"));
        loc = pos.coords.latitude.toFixed(5)+", "+pos.coords.longitude.toFixed(5);
        $("#geoBadge").textContent="OK";
      }catch(e){ $("#geoBadge").textContent="No disponible"; }
      navigator.vibrate?.([160,60,160]);
      const incident = { ts: Date.now(), type:"Emergencia", loc, sev: ["Bajo","Medio","Alto"][Math.floor(Math.random()*3)] };
      S.incidents.push(incident);
      saveAll();
      toast("üö® Emergencia registrada");
    }

    function shareLastIncident(){
      const last = S.incidents[S.incidents.length-1];
      if(!last){ toast("No hay incidentes"); return; }
      const text = `Emergencia Guardi√°n 360\n${new Date(last.ts).toLocaleString()}\nUbicaci√≥n: ${last.loc}\nSeveridad: ${last.sev}`;
      if(navigator.share){ navigator.share({title:"Emergencia", text}); }
      else { navigator.clipboard.writeText(text); toast("Copiado al portapapeles"); }
    }

    function renderIncidents(){
      const tb = $("#tablaIncidentes tbody"); tb.innerHTML="";
      S.incidents.slice().reverse().forEach(i=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${new Date(i.ts).toLocaleString()}</td><td>${i.type}</td><td>${i.loc}</td><td class="right">${i.sev}</td>`;
        tb.appendChild(tr);
      });
    }

    /* ========= Trabajador ========= */
    function saveWorker(){
      const name=$("#wName").value||"‚Äî";
      const role=$("#wRole").value||"‚Äî";
      const fat=+$("#wFatigue").value||0;
      const hr=$("#wHR").value||"";
      const epp=[...$$(".epp:checked")].map(x=>x.value).join(", ");
      const job=$("#wJob").value;
      S.workers.push({ts:Date.now(),name,role,fat,hr,epp,job});
      saveAll(); toast("‚úÖ Ingreso registrado");
    }

    function renderWorkers(){
      const tb=$("#tablaWorkers tbody"); tb.innerHTML="";
      S.workers.slice().reverse().forEach(w=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${new Date(w.ts).toLocaleString()}</td><td>${w.name}</td><td>${w.role}</td><td>${w.epp||"‚Äî"}</td><td>${w.fat}</td><td>${w.job}</td>`;
        tb.appendChild(tr);
      });
    }

    function genQR(){
      const data = encodeURIComponent(JSON.stringify({job:$("#wJob").value, at: now()}));
      const url = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${data}`;
      const img = $("#qrImg"); img.src=url; img.style.display="block"; toast("QR generado");
    }

    async function scanQR(){
      if('BarcodeDetector' in window){
        try{
          const det = new BarcodeDetector({formats:['qr_code']});
          const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
          const video = document.createElement('video'); video.srcObject=stream; await video.play();
          const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d');
          let found=false;
          const t = setInterval(async ()=>{
            if(video.readyState===video.HAVE_ENOUGH_DATA){
              canvas.width=video.videoWidth; canvas.height=video.videoHeight;
              ctx.drawImage(video,0,0); const bmp=await createImageBitmap(canvas);
              const codes = await det.detect(bmp); if(codes.length){ found=true; clearInterval(t); stream.getTracks().forEach(x=>x.stop());
                toast("QR le√≠do: "+codes[0].rawValue.slice(0,30)+"‚Ä¶"); }
            }
          },200);
        }catch(e){ toast("No se pudo acceder a la c√°mara"); }
      }else{ toast("Esc√°ner no soportado. Ingres√° manual."); }
    }

    /* ========= Entrenamiento ========= */
    const MODULOS = [
      {id:'epp', t:'Uso correcto del EPP', q:'¬øCu√°ndo cambiar una mascarilla N95?', a:'Cuando est√© h√∫meda, da√±ada o sucia; o tras 8h de uso continuo.'},
      {id:'inc', t:'Prevenci√≥n de incendios', q:'¬øQu√© hacer si ves un conato de incendio?', a:'Activar alarma, usar extintor adecuado si es seguro y evacuar.'},
      {id:'quim', t:'Manejo de qu√≠micos', q:'¬øQu√© es la HDS/FDI?', a:'Hoja de Datos de Seguridad/Ficha de Datos de Seguridad del producto qu√≠mico.'}
    ];
    function renderCap(){
      const box=$("#modulosList"); box.innerHTML="";
      if(S.caps.length===0) S.caps = MODULOS.map(m=>({id:m.id,title:m.t,done:false}));
      S.caps.forEach(m=>{
        const div=document.createElement('div');
        div.className="tile"; div.innerHTML=`<div class="icon">üìò</div><div><div class="title">${m.title}</div><div class="desc">${m.done?'Completado':'Pendiente'}</div></div><span class="badge" style="margin-left:auto">${m.done?'‚úÖ':'‚è≥'}</span>`;
        div.onclick=()=>{ ask(m); };
        box.appendChild(div);
      });
      $("#badgeCap").textContent = `${S.caps.filter(c=>c.done).length} completados`;
    }
    function ask(m){
      pushChat("sistema", `Pregunta: ${MODULOS.find(x=>x.id===m.id).q}`);
      pushChat("ai", MODULOS.find(x=>x.id===m.id).a);
      const idx=S.caps.findIndex(x=>x.id===m.id); S.caps[idx].done=true; saveAll();
    }
    function pushChat(who,text){
      const b=$("#chatBox"); const div=document.createElement('div');
      div.style.margin="6px 0"; div.innerHTML = `<div class="badge">${who==='ai'?'Tutor IA':'T√∫'}</div><div>${text}</div>`;
      b.appendChild(div); b.scrollTop = b.scrollHeight;
      speechSynthesis.cancel();
      if(who==='ai'){ const u = new SpeechSynthesisUtterance(text); u.lang='es-ES'; speechSynthesis.speak(u); $("#voiceBadge").textContent="TTS activo"; }
    }
    function sendChat(){
      const v=$("#chatInput").value.trim(); if(!v) return;
      $("#chatInput").value=""; pushChat("yo", v);
      // Respuestas simples
      const m=v.toLowerCase();
      if(m.includes("epp")) pushChat("ai","Record√° verificar talla y estado antes de cada uso.");
      else if(m.includes("incend")) pushChat("ai","Identific√° el tipo de fuego (A,B,C,D,K) y usa el extintor correcto.");
      else pushChat("ai","Gracias. He registrado tu consulta para revisi√≥n.");
    }
    let rec=null;
    function startVoice(){
      const R = window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!R){ toast("Voz no soportada"); return; }
      rec = new R(); rec.lang='es-ES'; rec.continuous=false; rec.onresult=e=>{ $("#chatInput").value = e.results[0][0].transcript; sendChat(); };
      rec.onend=()=>$("#voiceBadge").textContent="No activo";
      rec.start(); $("#voiceBadge").textContent="Escuchando‚Ä¶";
    }
    function stopVoice(){ rec?.stop(); $("#voiceBadge").textContent="No activo"; }

    /* ========= Sensores ========= */
    function addSensor(){
      const name=$("#sName").value.trim(), unit=$("#sUnit").value.trim();
      const min=+$("#sMin").value||0, max=+$("#sMax").value||100;
      if(!name||!unit){ toast("Completa nombre y unidad"); return; }
      const id = crypto.randomUUID();
      S.sensors.push({id,name,unit,min,max}); saveAll();
      $("#sName").value=$("#sUnit").value=$("#sMin").value=$("#sMax").value="";
      toast("Sensor agregado");
    }
    function latestReading(id){ const arr=S.readings.filter(r=>r.id===id); return arr[arr.length-1]; }
    function renderSensors(){
      const list=$("#sensoresList"); list.innerHTML="";
      S.sensors.forEach(s=>{
        const r = latestReading(s.id);
        const val = r? r.val.toFixed(1):"‚Äî";
        const ok = r? (r.val>=s.min && r.val<=s.max):true;
        const row=document.createElement('div');
        row.className="tile";
        row.innerHTML=`<div class="icon">üìà</div>
          <div style="flex:1"><div class="title">${s.name} <span class="muted">(${s.unit})</span></div>
          <div class="desc">Rango ${s.min}‚Äì${s.max} | √öltimo: <b>${val}</b></div></div>
          <span class="badge" style="border-color:${ok?'#22c55e':'#ef4444'}">${ok?'OK':'‚ö† Fuera de rango'}</span>`;
        list.appendChild(row);
      });
      drawLine($("#chartSens"), lastN(S.readings.map(r=>r.val), 40));
    }
    let sensTimer=null;
    function kickSensorsLoop(){
      clearInterval(sensTimer);
      sensTimer=setInterval(()=>{
        // generar lecturas
        S.sensors.forEach(s=>{
          const base=(s.min+s.max)/2 || 50;
          const amp= (s.max - s.min)/2 || 25;
          const val = base + (Math.random()*amp*2 - amp);
          S.readings.push({ts:Date.now(), id:s.id, val});
          if(S.readings.length>500) S.readings.shift();
        });
        saveAll();
      }, 2000);
    }

    /* ========= Mensajes ========= */
    function renderMsgs(){
      const box=$("#msgs"); box.innerHTML="";
      S.messages.forEach(m=>{
        const div=document.createElement('div'); div.style.margin="8px 0";
        div.innerHTML=`<div class="badge">${m.user}</div><div>${m.text}</div>`;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    }
    function sendMsg(){
      const t=$("#msgText").value.trim(); if(!t) return;
      $("#msgText").value=""; S.messages.push({ts:Date.now(), user:"T√∫", text:t}); saveAll();
    }

    /* ========= Reportes / empresa ========= */
    function calcCompliance(){
      const checks = $$(".chkIso");
      const pct = 100 * ([...checks].filter(c=>c.checked).length / checks.length || 0);
      S.compliance = pct; saveAll(); toast("Cumplimiento actualizado: "+pct.toFixed(0)+"%");
    }
    function saveCompany(){ S.company={name:$("#cName").value, site:$("#cSite").value}; saveAll(); toast("Empresa guardada"); }
    function resetAll(){ if(!confirm("¬øReiniciar todos los datos?")) return; localStorage.clear(); location.reload(); }

    /* ========= Exportaci√≥n ========= */
    function exportCSV(kind){
      let rows=[["ts"]];
      if(kind==="incidentes"){
        rows=[["fecha","tipo","ubicacion","severidad"]];
        S.incidents.forEach(i=>rows.push([new Date(i.ts).toISOString(), i.type, i.loc, i.sev]));
      }else if(kind==="workers"){
        rows=[["fecha","nombre","rol","epp","fatiga","tarea","hr"]];
        S.workers.forEach(w=>rows.push([new Date(w.ts).toISOString(), w.name, w.role, w.epp, w.fat, w.job, w.hr||""]));
      }else if(kind==="sensors"){
        rows=[["fecha","sensor","valor","unidad"]];
        S.readings.forEach(r=>{
          const s=S.sensors.find(x=>x.id===r.id); rows.push([new Date(r.ts).toISOString(), s?.name||r.id, r.val, s?.unit||""]);
        });
      }else if(kind==="messages"){
        rows=[["fecha","usuario","mensaje"]];
        S.messages.forEach(m=>rows.push([new Date(m.ts).toISOString(), m.user, m.text]));
      }
      const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download=`g360_${kind}.csv`; a.click(); URL.revokeObjectURL(a.href);
    }

    /* ========= Dibujar l√≠neas simples ========= */
    function drawLine(canvas, data){
      if(!canvas) return; const ctx=canvas.getContext('2d');
      const w=canvas.width=canvas.clientWidth, h=canvas.height=canvas.clientHeight;
      ctx.clearRect(0,0,w,h); if(!data.length) return;
      const min=Math.min(...data), max=Math.max(...data); const pad=12;
      ctx.strokeStyle="#334155"; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
      ctx.strokeStyle="#60a5fa"; ctx.lineWidth=2; ctx.beginPath();
      data.forEach((v,i)=>{
        const x = pad + i*( (w-2*pad)/(Math.max(1,data.length-1)) );
        const y = h-pad - ( (v-min)/(max-min||1) )*(h-2*pad);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    /* ========= Render general ========= */
    function renderAll(){
      renderDashboard();
      renderIncidents();
      renderWorkers();
      renderCap();
      renderSensors();
      renderMsgs();
      $("#offlineBadge").textContent = navigator.onLine ? "No" : "S√≠";
      $("#cName").value = S.company.name||""; $("#cSite").value = S.company.site||"";
    }

    // Datos demo m√≠nimos si est√° vac√≠o
    if(S.caps.length===0) S.caps = MODULOS.map(m=>({id:m.id,title:m.t,done:false}));
    if(S.sensors.length===0){
      S.sensors=[{id:'s1',name:'CO‚ÇÇ',unit:'ppm',min:350,max:1500},{id:'s2',name:'Temp',unit:'¬∞C',min:10,max:45},{id:'s3',name:'Ruido',unit:'dB',min:0,max:85}];
    }
    saveAll(); // normaliza y pinta
    window.addEventListener('online', ()=>renderAll());
    window.addEventListener('offline', ()=>{$("#offlineBadge").textContent="S√≠";});
  </script>
</body>
</html>
```Ó®Å0Ó®Ç
